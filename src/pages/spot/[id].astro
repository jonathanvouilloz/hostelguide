---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Badge from '../../components/ui/Badge.astro';
import { getAllSpots } from '../../lib/content';
import { getDirectionsUrl } from '../../lib/deeplinks';
import type { Spot, SpotCategory } from '../../lib/types';

export async function getStaticPaths() {
  const allSpots = await getAllSpots();
  const paths: { params: { id: string }; props: { spot: Spot; category: SpotCategory } }[] = [];

  for (const [category, spots] of Object.entries(allSpots)) {
    for (const spot of spots) {
      paths.push({
        params: { id: spot.id },
        props: { spot, category: category as SpotCategory },
      });
    }
  }

  return paths;
}

interface Props {
  spot: Spot;
  category: SpotCategory;
}

const { spot, category } = Astro.props;

// Support both coordinates and location (PagesCMS compatibility)
const coords = spot.coordinates || spot.location;
const directionsUrl = coords ? getDirectionsUrl(coords.lat, coords.lng) : null;

function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
}
---

<BaseLayout title={spot.name} description={spot.description} showNav={false}>
  <Header
    title={spot.name}
    showBack
    backHref={`/${category}`}
    transparent
  />

  <div class="spot-detail pb-28">
    <!-- Hero Image -->
    <div class="relative h-64 w-full -mt-16">
      {spot.image ? (
        <div
          class="absolute inset-0 bg-cover bg-center"
          style={`background-image: linear-gradient(to bottom, transparent 0%, rgba(16, 31, 34, 0.6) 70%, rgba(16, 31, 34, 1) 100%), url("${spot.image}");`}
        ></div>
      ) : (
        <div class="absolute inset-0 bg-[--color-surface-input] flex items-center justify-center">
          <span class="material-symbols-outlined text-[64px] text-[--color-text-secondary]/30">image</span>
        </div>
      )}

      <!-- Badges on image -->
      <div class="absolute bottom-4 left-4 flex items-center gap-2">
        {spot.cuisineType && (
          <Badge variant="info">{capitalize(spot.cuisineType)}</Badge>
        )}
        {spot.priceRange && (
          <Badge variant="default">{spot.priceRange}</Badge>
        )}
      </div>
    </div>

    <!-- Content -->
    <div class="px-4 pt-4 space-y-5">
      <!-- Header -->
      <header>
        <h1 class="text-2xl font-bold text-[--color-text]">{spot.name}</h1>
        {spot.tagline && (
          <p class="text-[--color-primary] font-medium mt-1">{spot.tagline}</p>
        )}

        <!-- Meta row -->
        <div class="flex items-center gap-4 mt-3 text-sm text-[--color-text-secondary]">
          {spot.rating && (
            <div class="flex items-center gap-1">
              <span class="material-symbols-outlined text-yellow-400 text-[18px] filled">star</span>
              <span class="font-bold text-[--color-text]">{spot.rating}</span>
            </div>
          )}
          {spot.walkingDistance && (
            <div class="flex items-center gap-1">
              <span class="material-symbols-outlined text-[18px]">directions_walk</span>
              <span>{spot.walkingDistance}</span>
            </div>
          )}
        </div>
      </header>

      <!-- Description -->
      <p class="text-base leading-relaxed text-[--color-text-secondary]">
        {spot.description}
      </p>

      <!-- Address Card -->
      {spot.address && (
        <div class="card p-4">
          <div class="flex items-start gap-3">
            <div class="flex size-10 items-center justify-center rounded-full bg-[--color-primary]/10 text-[--color-primary]">
              <span class="material-symbols-outlined">location_on</span>
            </div>
            <div class="flex-1">
              <p class="font-bold text-[--color-text]">Address</p>
              <p class="text-sm text-[--color-text-secondary] mt-1">{spot.address}</p>
            </div>
          </div>
        </div>
      )}

      <!-- Tags -->
      {spot.tags && spot.tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {spot.tags.map(tag => (
            <span class="text-sm text-[--color-primary]">#{tag}</span>
          ))}
        </div>
      )}
    </div>

    <!-- Sticky action buttons -->
    <div class="action-bar">
      {directionsUrl && (
        <a
          href={directionsUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="btn-primary flex-1 touch-target"
        >
          <span class="material-symbols-outlined text-[20px]">directions</span>
          <span>Get Directions</span>
        </a>
      )}
      <button
        type="button"
        class="btn-secondary copy-btn touch-target"
        data-address={spot.address}
        aria-label="Copy address to clipboard"
      >
        <span class="material-symbols-outlined text-[20px]">content_copy</span>
      </button>
    </div>
  </div>

  <!-- Copy feedback toast -->
  <div id="copy-toast" class="copy-toast">
    <span class="material-symbols-outlined text-[16px]">check_circle</span>
    Copied!
  </div>
</BaseLayout>

<script>
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const address = btn.getAttribute('data-address');
      const toast = document.getElementById('copy-toast');

      if (!address || !toast) return;

      try {
        await navigator.clipboard.writeText(address);
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  });
</script>

<style>
  .action-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
    background: linear-gradient(to top, var(--color-bg) 80%, transparent);
    z-index: 40;
  }

  .copy-toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background-color: var(--color-primary);
    color: var(--color-bg);
    padding: 0.75rem 1.25rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 100;
  }

  .copy-toast.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }
</style>
