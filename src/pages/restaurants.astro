---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import SearchBar from '../components/ui/SearchBar.astro';
import FilterChip from '../components/ui/FilterChip.astro';
import SpotCard from '../components/SpotCard.astro';
import { getSpots } from '../lib/content';
import type { CuisineType } from '../lib/types';

const allSpots = await getSpots('restaurants');

// Extract unique cuisine types from spots
const cuisineTypes = [...new Set(
  allSpots
    .map(s => s.cuisineType)
    .filter((t): t is CuisineType => t !== undefined)
)];

// Get filter from URL
const url = Astro.url;
const activeFilter = url.searchParams.get('cuisine') || 'all';

// Filter spots
const spots = activeFilter === 'all'
  ? allSpots
  : allSpots.filter(s => s.cuisineType === activeFilter);

function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
}
---

<BaseLayout title="Restaurants">
  <Header title="Eat & Drink" showBack backHref="/explore" rightIcon="map" />

  <!-- Search Bar -->
  <div class="px-4 pb-2">
    <SearchBar placeholder="Search for food, restaurants..." />
  </div>

  <!-- Filter Chips -->
  <div class="sticky top-16 z-10 w-full overflow-x-auto no-scrollbar bg-[--color-bg] py-3 px-4">
    <div class="flex gap-3">
      <FilterChip
        label="All"
        active={activeFilter === 'all'}
        href="/restaurants"
      />
      {cuisineTypes.map(type => (
        <FilterChip
          label={capitalize(type)}
          active={activeFilter === type}
          href={`/restaurants?cuisine=${type}`}
        />
      ))}
    </div>
  </div>

  <!-- Content -->
  <main class="flex flex-col gap-5 px-4 pt-2 pb-4">
    <!-- Hero Text -->
    <div class="py-2">
      <h2 class="text-2xl font-extrabold text-[--color-text] leading-tight">
        Hungry?
        <br />
        <span class="text-[--color-text-secondary] font-medium text-lg">
          Here's where the locals go.
        </span>
      </h2>
    </div>

    <!-- Spots List -->
    {spots.length > 0 ? (
      <div class="space-y-4">
        {spots.map((spot, index) => (
          <SpotCard spot={spot} featured={index === 0} />
        ))}
      </div>
    ) : (
      <div class="card p-6 text-center">
        <p class="text-[--color-text-secondary]">No restaurants found.</p>
      </div>
    )}

    <!-- Footer Text -->
    <div class="py-6 text-center">
      <p class="text-sm text-[--color-text-secondary]">
        Showing top recommendations near you.
      </p>
    </div>
  </main>
</BaseLayout>
