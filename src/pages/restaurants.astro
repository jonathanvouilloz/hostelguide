---
import BaseLayout from '../layouts/BaseLayout.astro';
import SpotCard from '../components/SpotCard.astro';
import { getSpots, getCategoryMeta } from '../lib/content';
import type { CuisineType } from '../lib/types';

const meta = getCategoryMeta('restaurants');
const allSpots = await getSpots('restaurants');

// Extract unique cuisine types from spots
const cuisineTypes = [...new Set(
  allSpots
    .map(s => s.cuisineType)
    .filter((t): t is CuisineType => t !== undefined)
)];

// Get filter from URL
const url = Astro.url;
const activeFilter = url.searchParams.get('cuisine') || 'all';

// Filter spots
const spots = activeFilter === 'all'
  ? allSpots
  : allSpots.filter(s => s.cuisineType === activeFilter);

function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
}
---

<BaseLayout title={meta?.name || 'Restaurants'}>
  <div class="p-4 max-w-md mx-auto pb-safe">
    <header class="mb-4">
      <h1 class="text-xl font-bold flex items-center gap-2">
        <span aria-hidden="true">{meta?.emoji}</span>
        {meta?.name}
      </h1>
      <p class="text-muted text-sm mt-1">{meta?.description}</p>
    </header>

    {cuisineTypes.length > 0 && (
      <nav class="filter-chips flex flex-wrap gap-2 mb-4" aria-label="Filter by cuisine">
        <a
          href="/restaurants"
          class:list={['chip', { active: activeFilter === 'all' }]}
        >
          All
        </a>
        {cuisineTypes.map(type => (
          <a
            href={`/restaurants?cuisine=${type}`}
            class:list={['chip', { active: activeFilter === type }]}
          >
            {capitalize(type)}
          </a>
        ))}
      </nav>
    )}

    {spots.length > 0 ? (
      <div class="spots-grid space-y-4">
        {spots.map(spot => (
          <SpotCard spot={spot} showCuisine={activeFilter === 'all'} />
        ))}
      </div>
    ) : (
      <div class="empty-state card p-6 text-center">
        <p class="text-muted">No restaurants found.</p>
      </div>
    )}

    <div class="mt-6 text-center">
      <a href="/" class="btn-secondary inline-block">
        ‚Üê Back to Home
      </a>
    </div>
  </div>
</BaseLayout>

<style>
  .chip {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    background-color: #f3f4f6;
    color: #374151;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .chip:hover {
    background-color: #e5e7eb;
  }

  .chip.active {
    background-color: var(--color-primary);
    color: white;
  }
</style>
